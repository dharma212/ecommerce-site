{% extends "base.html" %}
{% block content %}

<!-- ================= LOADER ================= -->
<div id="checkout-loader" class="payment-overlay d-none">
  <div class="loader-card text-center">
    <div class="spinner-border text-primary" role="status"
      style="width: 3.5rem; height: 3.5rem"></div>
    <h4 class="mt-4 fw-bold">Processing Order...</h4>
    <p class="text-muted">Please wait while we secure your payment.</p>
  </div>
</div>

<!-- ================= SUCCESS ================= -->
<div id="success-overlay" class="success-full-page d-none">
  <div class="success-anim-wrap text-center">
    <div class="check-container">
      <i class="fa-solid fa-check"></i>
    </div>
    <h1 class="display-3 fw-bold mt-4">Order Confirmed!</h1>
    <p class="lead">Redirecting to your orders...</p>
    <div class="confetti"></div>
  </div>
</div>

<!-- ================= MAIN ================= -->
<div class="container-fluid pay-wrap px-lg-5">
  <div class="row g-4 min-vh-100 align-items-stretch">
    <div class="col-lg-8 col-12">
      <div class="main-pay-card h-100">

        <!-- ===== PAYMENT METHODS ===== -->
        <div class="pay-sidebar">
          <div class="pay-method-item is-active" onclick="toggleMethod('upi', this)">
            <i class="fa-brands fa-google-pay fs-4"></i> UPI Options
          </div>
          <div class="pay-method-item" onclick="toggleMethod('card', this)">
            <i class="fa-solid fa-credit-card"></i> Cards (Debit/Credit)
          </div>
          <div class="pay-method-item" onclick="toggleMethod('cod', this)">
            <i class="fa-solid fa-truck"></i> Cash on Delivery
          </div>
        </div>

        <!-- ===== PAYMENT CONTENT ===== -->
        <div class="pay-content">
          <form id="orderForm" method="POST" action="{% url 'payment' %}" onsubmit="runCheckout(event)">
            {% csrf_token %}

            <input type="hidden" name="payment_method" id="payment_method" value="upi">

            {% if reorder %}
              <input type="hidden" name="reorder_id" value="{{ old_order.id }}">
            {% endif %}
            
            {% if buy_now %}
              <input type="hidden" name="buy_now_id" value="{{ product.id }}">
            {% endif %}


            <!-- ===== UPI ===== -->
            <div id="panel-upi" class="content-panel is-visible">
              <h5 class="fw-bold mb-3">Pay using UPI</h5>
              <input type="text" class="form-input-box" placeholder="e.g. 9876543210@upi" />
              <button type="submit" class="btn-submit-order mt-3">
                Pay ₹<span class="pay-btn-amount">{{ total_price|add:7 }}</span>
              </button>
            </div>

            <!-- ===== CARD ===== -->
            <div id="panel-card" class="content-panel">
              <h5 class="fw-bold mb-3">Card Details</h5>
              <input type="text" class="form-input-box" placeholder="Card Number" />
              <div class="row g-2">
                <div class="col-6">
                  <input type="text" class="form-input-box" placeholder="MM/YY" />
                </div>
                <div class="col-6">
                  <input type="password" class="form-input-box" placeholder="CVV" />
                </div>
              </div>
              <button type="submit" class="btn-submit-order mt-2">
                Pay ₹<span class="pay-btn-amount">{{ total_price|add:7 }}</span>
              </button>
            </div>

            <!-- ===== COD ===== -->
            <div id="panel-cod" class="content-panel">
              <div class="text-center py-3">
                <i class="fa-solid fa-circle-check text-success display-4 mb-3"></i>
                <h5 class="fw-bold">Confirm Cash on Delivery</h5>
                <p class="text-muted">
                  Pay ₹<span class="pay-btn-amount">{{ total_price|add:47 }}</span> at the time of delivery.
                </p>
              </div>
              <button type="submit" class="btn-submit-order">
                Confirm Order
              </button>
            </div>

          </form>
        </div>
      </div>
    </div>

    <!-- ===== PRICE SUMMARY ===== -->
    <div class="col-lg-4">
      <div class="summary-card">
        <h6 class="text-muted fw-bold mb-4">PRICE DETAILS</h6>

        <div class="d-flex justify-content-between mb-3">
          <span>Price ({{ items_count }} items)</span>
          <span class="fw-bold">₹{{ total_price }}</span>
        </div>

        <div class="d-flex justify-content-between mb-3">
          <span>Platform Fee</span>
          <span>₹7</span>
        </div>

        <div class="d-flex justify-content-between mb-3">
          <span>Delivery Charges</span>
          <span class="text-success fw-bold" id="deliveryCharge">Free</span>
        </div>

        <hr />

        <div class="d-flex justify-content-between mb-3 fs-5 fw-bold">
          <span>Total Amount</span>
          <span class="text-primary" id="finalAmount">
            ₹{{ total_price|add:7 }}
          </span>
        </div>

        <div class="text-success small fw-bold">
          <i class="fa-solid fa-shield-check"></i> Safe and Secure Payments
        </div>
      </div>
    </div>

  </div>
</div>

<!-- ================= JAVASCRIPT ================= -->
<script>
const BASE_TOTAL = parseInt("{{ total_price }}");
const PLATFORM_FEE = 7;
const COD_FEE = 40;

function toggleMethod(id, btn) {

  document.querySelectorAll(".content-panel")
    .forEach(p => p.classList.remove("is-visible"));

  document.querySelectorAll(".pay-method-item")
    .forEach(i => i.classList.remove("is-active"));

  document.getElementById("panel-" + id).classList.add("is-visible");
  btn.classList.add("is-active");

  document.getElementById("payment_method").value = id;

  let delivery = (id === "cod") ? COD_FEE : 0;
  let finalTotal = BASE_TOTAL + PLATFORM_FEE + delivery;

  document.getElementById("deliveryCharge").innerText =
    delivery === 0 ? "Free" : "₹" + delivery;

  document.getElementById("finalAmount").innerText = "₹" + finalTotal;

  document.querySelectorAll(".pay-btn-amount")
    .forEach(el => el.innerText = finalTotal);
}

function runCheckout(e) {
  e.preventDefault();

  const loader = document.getElementById("checkout-loader");
  const successOverlay = document.getElementById("success-overlay");
  const form = e.target;

  loader.classList.remove("d-none");

  setTimeout(() => {
    loader.classList.add("d-none");
    successOverlay.classList.remove("d-none");

    setTimeout(() => {
      form.submit();
    }, 1500);
  }, 2000);
}
</script>

{% endblock %}
